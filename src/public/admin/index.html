<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
  <div class="admin-container">
    <header class="admin-header">
      <h1>é‚€è«‹ç®¡ç†</h1>
      <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
    </header>

    <div class="admin-content">
      <div class="controls">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="ä½¿ç”¨åç¨±æˆ–ä»£ç¢¼æœå°‹...">
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="copyAllNames()" id="copyAllBtn">
            <span class="btn-text">ğŸ“‹ è¤‡è£½å…¨éƒ¨åå–®</span>
            <span class="btn-success" style="display: none;">âœ“ å·²è¤‡è£½</span>
          </button>
          <button class="btn btn-primary" onclick="showCreateModal()">+ æ–°å¢é‚€è«‹</button>
        </div>
      </div>

      <div class="invitations-list" id="invitationsList">
        <p class="loading">è¼‰å…¥é‚€è«‹ä¸­...</p>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="invitationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">æ–°å¢é‚€è«‹</h2>
      <form id="invitationForm">
        <input type="hidden" id="invitationId">

        <div class="form-group">
          <label for="name">åç¨± *</label>
          <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
          <label for="pronoun">ä»£åè©</label>
          <input type="text" id="pronoun" name="pronoun" placeholder="ä¾‹å¦‚ï¼šå…ˆç”Ÿï¼å°å§ï¼ä»–ï¼å¥¹">
        </div>

        <div class="form-group">
          <label for="message">é‚€è«‹è¨Šæ¯ *</label>
          <textarea id="message" name="message" rows="5" required></textarea>
        </div>

        <div class="form-group">
          <label for="slug">è‡ªè¨‚ä»£ç¢¼ï¼ˆç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆï¼‰</label>
          <input type="text" id="slug" name="slug" pattern="[a-z0-9]+" title="åƒ…é™å°å¯«å­—æ¯å’Œæ•¸å­—">
          <small>åƒ…é™å°å¯«å­—æ¯å’Œæ•¸å­—ã€‚ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆ5ä½ä»£ç¢¼ã€‚</small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">å„²å­˜</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentInvitations = [];

    const loadInvitations = async () => {
      try {
        const response = await fetch('/api/invitations');
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load invitations');
        }
        currentInvitations = await response.json();
        renderInvitations(currentInvitations);
      } catch (error) {
        document.getElementById('invitationsList').innerHTML =
          '<p class="error">Error loading invitations</p>';
      }
    }

    const renderInvitations = (invitations) => {
      const container = document.getElementById('invitationsList');
      const baseUrl = window.location.origin;

      if (invitations.length === 0) {
        container.innerHTML = '<p class="no-invitations">No invitations found.</p>';
        return;
      }

      container.innerHTML = invitations.map(inv => `
        <div class="invitation-item" data-id="${inv.id}">
          <div class="invitation-info">
            <h3>${inv.name} (${inv.pronoun})</h3>
            <p class="slug">Slug: ${inv.slug}</p>
            <p class="message-preview">${inv.message.substring(0, 100)}${inv.message.length > 100 ? '...' : ''}</p>
          </div>
          <div class="invitation-actions">
            <button class="btn btn-small copy-btn" onclick="copyInviteLink('${baseUrl}/?invite=${inv.slug}', this)">
              <span class="btn-text">ğŸ“‹ è¤‡è£½</span>
              <span class="btn-success" style="display: none;">âœ“ å·²è¤‡è£½</span>
            </button>
            <button class="btn btn-small" onclick="editInvitation(${inv.id})">âœï¸ ç·¨è¼¯</button>
            <button class="btn btn-small btn-danger" onclick="deleteInvitation(${inv.id})">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
      `).join('');
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', async (e) => {
      const query = e.target.value;

      if (query.length === 0) {
        renderInvitations(currentInvitations);
        return;
      }

      try {
        const response = await fetch(`/api/invitations?search=${encodeURIComponent(query)}`);
        const invitations = await response.json();
        renderInvitations(invitations);
      } catch (error) {
        console.error('æœå°‹é‚€è«‹æ™‚å‡ºéŒ¯ï¼š', error);
      }
    });

    const showCreateModal = () => {
      document.getElementById('modalTitle').textContent = 'æ–°å¢é‚€è«‹';
      document.getElementById('invitationForm').reset();
      document.getElementById('invitationId').value = '';
      document.getElementById('invitationModal').style.display = 'block';
    }

    const closeModal = () => {
      document.getElementById('invitationModal').style.display = 'none';
    }

    const editInvitation = async (id) => {
      try {
        const response = await fetch(`/api/invitations/${id}`);
        const invitation = await response.json();

        document.getElementById('modalTitle').textContent = 'Edit Invitation';
        document.getElementById('invitationId').value = invitation.id;
        document.getElementById('name').value = invitation.name;
        document.getElementById('pronoun').value = invitation.pronoun;
        document.getElementById('message').value = invitation.message;
        document.getElementById('slug').value = invitation.slug;
        document.getElementById('invitationModal').style.display = 'block';
      } catch (error) {
        alert('Error loading invitation');
      }
    }

    const deleteInvitation = async (id) => {
      if (!confirm('Are you sure you want to delete this invitation?')) {
        return;
      }

      try {
        const response = await fetch(`/api/invitations/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          loadInvitations();
        } else {
          alert('Error deleting invitation');
        }
      } catch (error) {
        alert('Error deleting invitation');
      }
    }

    const copyInviteLink = (url, button) => {
      navigator.clipboard.writeText(url).then(() => {
        const btnText = button.querySelector('.btn-text');
        const btnSuccess = button.querySelector('.btn-success');

        // Hide text, show checkmark
        btnText.style.display = 'none';
        btnSuccess.style.display = 'inline';
        button.classList.add('btn-copied');

        // Reset after 2 seconds
        setTimeout(() => {
          btnText.style.display = 'inline';
          btnSuccess.style.display = 'none';
          button.classList.remove('btn-copied');
        }, 2000);
      }).catch(() => {
        prompt('Copy this link:', url);
      });
    }

    const logout = async () => {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        window.location.href = '/login';
      }
    }

    const copyAllNames = () => {
      if (currentInvitations.length === 0) {
        alert('ç„¡é‚€è«‹åå–®');
        return;
      }

      const namesList = currentInvitations
        .map(inv => {
          const pronoun = inv.pronoun ? ` (${inv.pronoun})` : '';
          return `${inv.name}${pronoun}`;
        })
        .join('<br>');

      navigator.clipboard.writeText(namesList).then(() => {
        const button = document.getElementById('copyAllBtn');
        const btnText = button.querySelector('.btn-text');
        const btnSuccess = button.querySelector('.btn-success');
        
        // Hide text, show checkmark
        btnText.style.display = 'none';
        btnSuccess.style.display = 'inline';
        button.classList.add('btn-copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
          btnText.style.display = 'inline';
          btnSuccess.style.display = 'none';
          button.classList.remove('btn-copied');
        }, 2000);
      }).catch(() => {
        prompt('è¤‡è£½æ­¤åå–®:', namesList);
      });
    }

    // Form submission
    document.getElementById('invitationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('invitationId').value;
      const data = {
        name: document.getElementById('name').value,
        pronoun: document.getElementById('pronoun').value,
        message: document.getElementById('message').value,
        slug: document.getElementById('slug').value
      };

      try {
        const url = id ? `/api/invitations/${id}` : '/api/invitations';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          closeModal();
          loadInvitations();
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      } catch (error) {
        alert('Error saving invitation');
      }
    });

    // Close modal when clicking outside
    window.onclick = (event) => {
      const modal = document.getElementById('invitationModal');
      if (event.target === modal) {
        closeModal();
      }
    };

    // Load invitations on page load
    loadInvitations();
  </script>
</body>

</html>