<!doctype html>
<html lang="zh-Hant-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ç®¡ç†å“¡ä»‹é¢ | åŠå¬Œé¢</title>
		<link rel="stylesheet" href="/admin.css" />
		<link rel="icon" type="image/png" href="/img/favicon/favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/svg+xml" href="/img/favicon/favicon.svg" />
		<link rel="shortcut icon" href="/img/favicon/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png" />
		<link rel="manifest" href="/img/favicon/site.webmanifest" />
	</head>

	<body>
		<div class="admin-container">
			<header class="admin-header">
				<div class="header-left">
					<a href="/" class="btn btn-secondary btn-small" style="text-decoration: none">â† è¿”å›ä¸»é </a>
					<h1>é‚€è«‹ç®¡ç†</h1>
				</div>
				<button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
			</header>

			<div class="admin-content">
				<div class="controls">
					<div class="search-bar">
						<input type="text" id="searchInput" placeholder="ä½¿ç”¨åç¨±æˆ–ä»£ç¢¼æœå°‹..." />
					</div>
					<div style="display: flex; gap: 8px">
						<button class="btn btn-secondary" onclick="copyAllNames()" id="copyAllBtn">
							<span class="btn-text">ğŸ“‹ è¤‡è£½å…¨éƒ¨åå–®</span>
							<span class="btn-success" style="display: none">âœ“ å·²è¤‡è£½</span>
						</button>
						<button class="btn btn-primary" onclick="showCreateModal()">+ æ–°å¢é‚€è«‹</button>
					</div>
				</div>

				<div class="invitations-list" id="invitationsList">
					<p class="loading">è¼‰å…¥é‚€è«‹ä¸­...</p>
				</div>

				<!-- RSVP Section -->
				<div style="margin-top: 48px">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
						<h2>å›è¦†çµ±è¨ˆ</h2>
						<button class="btn btn-secondary" onclick="exportRSVPs()">ğŸ“¥ åŒ¯å‡ºå›è¦†</button>
					</div>
					<div id="rsvpStats" style="display: flex; gap: 16px; margin-bottom: 24px">
						<div style="padding: 16px; background: #f0f0f0; border-radius: 8px; flex: 1">
							<div style="font-size: 24px; font-weight: bold" id="yesCount">0</div>
							<div>å°‡æœƒå‡ºå¸­</div>
						</div>
						<div style="padding: 16px; background: #f0f0f0; border-radius: 8px; flex: 1">
							<div style="font-size: 24px; font-weight: bold" id="noCount">0</div>
							<div>ç„¡æ³•å‰ä¾†</div>
						</div>
						<div style="padding: 16px; background: #f0f0f0; border-radius: 8px; flex: 1">
							<div style="font-size: 24px; font-weight: bold" id="noResponseCount">0</div>
							<div>æœªå›è¦†</div>
						</div>
					</div>
					<div class="invitations-list" id="rsvpList">
						<p class="loading">è¼‰å…¥å›è¦†ä¸­...</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Create/Edit Modal -->
		<div id="invitationModal" class="modal">
			<div class="modal-content">
				<span class="close" onclick="closeModal()">&times;</span>
				<h2 id="modalTitle">æ–°å¢é‚€è«‹</h2>
				<form id="invitationForm">
					<input type="hidden" id="invitationId" />

					<div class="form-group">
						<label for="name">åç¨± *</label>
						<input type="text" id="name" name="name" required />
					</div>

					<div class="form-group">
						<label for="pronoun">ä»£åè©</label>
						<input type="text" id="pronoun" name="pronoun" placeholder="ä¾‹å¦‚ï¼šå…ˆç”Ÿï¼å°å§ï¼ä»–ï¼å¥¹" />
					</div>

					<div class="form-group">
						<label for="message">é‚€è«‹è¨Šæ¯ *</label>
						<textarea id="message" name="message" rows="5" required></textarea>
					</div>

					<div class="form-group">
						<label for="slug">è‡ªè¨‚ä»£ç¢¼ï¼ˆç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆï¼‰</label>
						<input type="text" id="slug" name="slug" pattern="[a-z0-9]+" title="åƒ…é™å°å¯«å­—æ¯å’Œæ•¸å­—" />
						<small>åƒ…é™å°å¯«å­—æ¯å’Œæ•¸å­—ã€‚ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆ5ä½ä»£ç¢¼ã€‚</small>
					</div>

					<div class="form-group checkbox-group">
						<input type="checkbox" id="inviteToParty" name="inviteToParty" checked />
						<label for="inviteToParty">é‚€è«‹åƒåŠ æ´¾å°</label>
					</div>

					<div class="form-actions">
						<button type="submit" class="btn btn-primary">å„²å­˜</button>
						<button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			let currentInvitations = [];
			let currentRSVPs = [];

			const loadInvitations = async () => {
				try {
					const response = await fetch("/api/invitations");
					if (!response.ok) {
						if (response.status === 401) {
							window.location.href = "/login";
							return;
						}
						throw new Error("Failed to load invitations");
					}
					currentInvitations = await response.json();
					renderInvitations(currentInvitations);
				} catch (error) {
					document.getElementById("invitationsList").innerHTML = '<p class="error">Error loading invitations</p>';
				}
			};

			const renderInvitations = invitations => {
				const container = document.getElementById("invitationsList");
				const baseUrl = window.location.origin;

				if (invitations.length === 0) {
					container.innerHTML = '<p class="no-invitations">No invitations found.</p>';
					return;
				}

				container.innerHTML = invitations
					.map(inv => {
						const partyStatus = inv.inviteToParty !== false ? '<span class="party-status invited">ğŸ‰ æ´¾å°</span>' : '<span class="party-status not-invited">âŒ ä¸åƒåŠ </span>';
						return `
        <div class="invitation-item" data-id="${inv.id}">
          <div class="invitation-info">
            <h3>${inv.name} (${inv.pronoun})</h3>
            <p class="slug">Slug: ${inv.slug} ${partyStatus}</p>
            <p class="message-preview">${inv.message.substring(0, 100)}${inv.message.length > 100 ? "..." : ""}</p>
          </div>
          <div class="invitation-actions">
            <button class="btn btn-small copy-btn" onclick="copyInviteLink('${baseUrl}/?invite=${inv.slug}', this)">
              <span class="btn-text">ğŸ“‹ è¤‡è£½</span>
              <span class="btn-success" style="display: none;">âœ“ å·²è¤‡è£½</span>
            </button>
            <button class="btn btn-small" onclick="editInvitation(${inv.id})">âœï¸ ç·¨è¼¯</button>
            <button class="btn btn-small btn-danger" onclick="deleteInvitation(${inv.id})">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
      `;
					})
					.join("");
			};

			// Search functionality
			document.getElementById("searchInput").addEventListener("input", async e => {
				const query = e.target.value;

				if (query.length === 0) {
					renderInvitations(currentInvitations);
					return;
				}

				try {
					const response = await fetch(`/api/invitations?search=${encodeURIComponent(query)}`);
					const invitations = await response.json();
					renderInvitations(invitations);
				} catch (error) {
					console.error("æœå°‹é‚€è«‹æ™‚å‡ºéŒ¯ï¼š", error);
				}
			});

			const showCreateModal = () => {
				document.getElementById("modalTitle").textContent = "æ–°å¢é‚€è«‹";
				document.getElementById("invitationForm").reset();
				document.getElementById("invitationId").value = "";
				document.getElementById("invitationModal").style.display = "block";
			};

			const closeModal = () => {
				document.getElementById("invitationModal").style.display = "none";
			};

			const editInvitation = async id => {
				try {
					const response = await fetch(`/api/invitations/${id}`);
					const invitation = await response.json();

					document.getElementById("modalTitle").textContent = "Edit Invitation";
					document.getElementById("invitationId").value = invitation.id;
					document.getElementById("name").value = invitation.name;
					document.getElementById("pronoun").value = invitation.pronoun;
					document.getElementById("message").value = invitation.message;
					document.getElementById("slug").value = invitation.slug;
					document.getElementById("inviteToParty").checked = invitation.inviteToParty !== false;
					document.getElementById("invitationModal").style.display = "block";
				} catch (error) {
					alert("Error loading invitation");
				}
			};

			const deleteInvitation = async id => {
				if (!confirm("Are you sure you want to delete this invitation?")) {
					return;
				}

				try {
					const response = await fetch(`/api/invitations/${id}`, {
						method: "DELETE"
					});

					if (response.ok) {
						loadInvitations();
					} else {
						alert("Error deleting invitation");
					}
				} catch (error) {
					alert("Error deleting invitation");
				}
			};

			const copyInviteLink = (url, button) => {
				navigator.clipboard
					.writeText(url)
					.then(() => {
						const btnText = button.querySelector(".btn-text");
						const btnSuccess = button.querySelector(".btn-success");

						// Hide text, show checkmark
						btnText.style.display = "none";
						btnSuccess.style.display = "inline";
						button.classList.add("btn-copied");

						// Reset after 2 seconds
						setTimeout(() => {
							btnText.style.display = "inline";
							btnSuccess.style.display = "none";
							button.classList.remove("btn-copied");
						}, 2000);
					})
					.catch(() => {
						prompt("Copy this link:", url);
					});
			};

			const logout = async () => {
				try {
					await fetch("/api/admin/logout", { method: "POST" });
					window.location.href = "/login";
				} catch (error) {
					window.location.href = "/login";
				}
			};

			const copyAllNames = () => {
				if (currentInvitations.length === 0) {
					alert("ç„¡é‚€è«‹åå–®");
					return;
				}

				const namesList = currentInvitations
					.map(inv => {
						const pronoun = inv.pronoun ? ` (${inv.pronoun})` : "";
						return `${inv.name}${pronoun}`;
					})
					.join("\n");

				navigator.clipboard
					.writeText(namesList)
					.then(() => {
						const button = document.getElementById("copyAllBtn");
						const btnText = button.querySelector(".btn-text");
						const btnSuccess = button.querySelector(".btn-success");

						// Hide text, show checkmark
						btnText.style.display = "none";
						btnSuccess.style.display = "inline";
						button.classList.add("btn-copied");

						// Reset after 2 seconds
						setTimeout(() => {
							btnText.style.display = "inline";
							btnSuccess.style.display = "none";
							button.classList.remove("btn-copied");
						}, 2000);
					})
					.catch(() => {
						prompt("è¤‡è£½æ­¤åå–®:", namesList);
					});
			};

			// Form submission
			document.getElementById("invitationForm").addEventListener("submit", async e => {
				e.preventDefault();

				const id = document.getElementById("invitationId").value;
				const data = {
					name: document.getElementById("name").value,
					pronoun: document.getElementById("pronoun").value,
					message: document.getElementById("message").value,
					slug: document.getElementById("slug").value,
					inviteToParty: document.getElementById("inviteToParty").checked
				};

				try {
					const url = id ? `/api/invitations/${id}` : "/api/invitations";
					const method = id ? "PUT" : "POST";

					const response = await fetch(url, {
						method,
						headers: {
							"Content-Type": "application/json"
						},
						body: JSON.stringify(data)
					});

					if (response.ok) {
						closeModal();
						loadInvitations();
					} else {
						const error = await response.json();
						alert(`Error: ${error.error}`);
					}
				} catch (error) {
					alert("Error saving invitation");
				}
			});

			// Close modal when clicking outside
			window.onclick = event => {
				const modal = document.getElementById("invitationModal");
				if (event.target === modal) {
					closeModal();
				}
			};

			// Load RSVP responses
			const loadRSVPs = async () => {
				try {
					const response = await fetch("/api/rsvps");
					if (!response.ok) {
						throw new Error("Failed to load RSVPs");
					}
					currentRSVPs = await response.json();
					renderRSVPs(currentRSVPs);
					updateRSVPStats();
				} catch (error) {
					document.getElementById("rsvpList").innerHTML = '<p class="error">Error loading RSVPs</p>';
				}
			};

			const renderRSVPs = rsvps => {
				const container = document.getElementById("rsvpList");

			// Filter out unknown names
			const filteredRsvps = rsvps.filter(rsvp => rsvp.invitation_name && rsvp.invitation_name !== "æœªçŸ¥");

			if (filteredRsvps.length === 0) {
				container.innerHTML = '<p class="no-invitations">å°šç„¡å›è¦†</p>';
				return;
			}

			container.innerHTML = filteredRsvps
				.map(rsvp => {
					const responseText = rsvp.response === "yes" ? '<span style="color: #4CAF50; font-weight: bold;">âœ“ å°‡å‡ºå¸­</span>' : '<span style="color: #ff69b4; font-weight: bold;">âœ— ç„¡æ³•å‰ä¾†</span>';
					const invitationName = rsvp.invitation_name;
						const pronoun = rsvp.invitation_pronoun ? ` (${rsvp.invitation_pronoun})` : "";
						return `
						<div class="invitation-item">
							<div class="invitation-info">
								<h3>${invitationName}${pronoun}</h3>
								<p class="slug">Slug: ${rsvp.slug} | ${responseText}</p>
								<p style="font-size: 12px; color: #666;">å›è¦†æ™‚é–“: ${new Date(rsvp.updated_at).toLocaleString("zh-TW")}</p>
							</div>
						</div>
					`;
					})
					.join("");
			};

			const updateRSVPStats = () => {
				const totalInvitations = currentInvitations.length;
				// Filter out unknown names before counting
				const filteredRsvps = currentRSVPs.filter(rsvp => rsvp.invitation_name && rsvp.invitation_name !== "æœªçŸ¥");
				const yesResponses = filteredRsvps.filter(r => r.response === "yes").length;
				const noResponses = filteredRsvps.filter(r => r.response === "no").length;
				const noResponse = totalInvitations - filteredRsvps.length;

				document.getElementById("yesCount").textContent = yesResponses;
				document.getElementById("noCount").textContent = noResponses;
				document.getElementById("noResponseCount").textContent = noResponse;
			};

			const exportRSVPs = () => {
			// Filter out unknown names
			const filteredRsvps = currentRSVPs.filter(rsvp => rsvp.invitation_name && rsvp.invitation_name !== "æœªçŸ¥");

			if (filteredRsvps.length === 0) {
				alert("ç„¡å›è¦†å¯åŒ¯å‡º");
				return;
			}

			// Create CSV content
			const csvRows = [["åç¨±", "ä»£åè©", "Slug", "å›è¦†", "å›è¦†æ™‚é–“"].join(",")];

			filteredRsvps.forEach(rsvp => {
				const name = rsvp.invitation_name;
					const pronoun = rsvp.invitation_pronoun || "";
					const response = rsvp.response === "yes" ? "å°‡å‡ºå¸­" : "ç„¡æ³•å‰ä¾†";
					const time = new Date(rsvp.updated_at).toLocaleString("zh-TW");
					csvRows.push([name, pronoun, rsvp.slug, response, time].join(","));
				});

				const csvContent = csvRows.join("\n");
				const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
				const link = document.createElement("a");
				const url = URL.createObjectURL(blob);

				link.setAttribute("href", url);
				link.setAttribute("download", `rsvp_responses_${new Date().toISOString().split("T")[0]}.csv`);
				link.style.visibility = "hidden";
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			};

			// Load invitations on page load
			loadInvitations();
			loadRSVPs();
		</script>
	</body>
</html>
